//
//  HYProjectNetRequestManager.m
//  HaoYuClient
//
//  Created by åˆ˜æ–‡å¼º on 2018/5/21.
//  Copyright Â© 2018å¹´ LWQ. All rights reserved.
//

#import "HYProjectNetRequestManager.h"

@interface HYProjectNetRequestManager()

/**
 *  è¯·æ±‚å­˜å‚¨æ•°ç»„, æ–¹ä¾¿å•ä¸ªè¯·æ±‚ç§»é™¤
 */
@property (nonatomic,strong) NSMutableArray *requests;

/**
 *  å­˜å‚¨æ‰€æœ‰è¯·æ±‚ä¿¡æ¯,æ–¹ä¾¿å•ä¸ªè¯·æ±‚åšç‰¹æ®Šå¤„ç†
 */
@property (nonatomic,strong) NSMutableArray *requestInfo;
    
@end

@implementation HYProjectNetRequestManager
#pragma mark - Zero.LifeCycle
    
    /**
     *  è·å–ç½‘ç»œè¯·æ±‚å·¥å…·ç±»å•åˆ©
     */
+ (HYProjectNetRequestManager *)sharedNetRequestManager{
    static HYProjectNetRequestManager *instance                 = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken,^{
        if (!instance) {
            instance = [[self alloc] init];
            
            /**
             *  å¯åŠ¨ç½‘ç»œç›‘æµ‹
             */
            [instance startMonitoring];
        }
    });
    return instance;
}
    
#pragma mark - First.Auxiliary
    
    /**
     *  å¼€å¯ç½‘ç»œç›‘æµ‹
     */
- (void)startMonitoring
    {
        AFNetworkReachabilityManager *mgr                           = [AFNetworkReachabilityManager sharedManager];
        [mgr setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) {
            
            /**
             *  å½“ç½‘ç»œçŠ¶æ€æ”¹å˜äº†, å°±ä¼šè°ƒç”¨è¿™ä¸ªblock
             */
            self.currentNetStatus = status;
            if (status == AFNetworkReachabilityStatusNotReachable) {
                ALERT(@"ç½‘ç»œå·²æ–­å¼€...");
                POST_NOTI(NONETWORK_FOR_BASETABLEVIEWCONTROLL_SHOWBLANKPAGE_NOTI, nil);
            }
            /**
             *  TODO:æ ¹æ®çŠ¶æ€æç¤ºç”¨æˆ·å½“å‰æ˜¯ä»€ä¹ˆç½‘ç»œçŠ¶æ€
             */
        }];
        
        [mgr startMonitoring];
    }
    
#pragma mark - Second.CoreFunc
    
- (NSURLSessionDataTask *)connectNetWithUrl:(NSString *)url
                         requestNetworkType:(HYProjectNetRequestType)networkRequestType
                                 parameters:(NSDictionary *)parameter
                            timeoutInterval:(NSTimeInterval)timeoutInterval
                               successBlock:(HYNetRequestSuccessBlock)successBlock
                               failureBlock:(HYNetRequestFailureBlock)failureBlock
    {
        NSURLSessionDataTask * dataTask;
        
        /**
         *  é…ç½®è¯·æ±‚å¤´ä¿¡æ¯
         */
        self.sessionManager.requestSerializer =  [AFJSONRequestSerializer serializer];
        [HYNetRequestEncyptFatory setRequestHeaderWithSessionManager:self.sessionManager];
        
        switch (networkRequestType) {
            
            /**
             *  GETè¯·æ±‚
             */
            case HYProjectNetRequestGet:
            dataTask = [self getRequest:url
                             parameters:parameter
                        timeoutInterval:timeoutInterval
                           successBlock:successBlock
                           failureBlock:failureBlock];
            break;
            
            /**
             *  POSTè¯·æ±‚
             */
            case HYProjectNetRequestPost:
            dataTask = [self postRequest:url
                              parameters:parameter
                         timeoutInterval:timeoutInterval
                            successBlock:successBlock
                            failureBlock:failureBlock];
            break;
            
            default:{
                dataTask = [self postRequest:url
                                  parameters:parameter
                             timeoutInterval:timeoutInterval
                                successBlock:successBlock
                                failureBlock:failureBlock];
            }
            break;
        }
        return dataTask;
    }
    
/**
 *  getç½‘ç»œè¯·æ±‚
 *
 *  @param url                          urlé“¾æ¥
 *  @param parameter                    è¯·æ±‚å‚æ•°
 *  @param timeoutInterval              è¶…æ—¶æ—¶é—´
 *  @param successBlock                 æˆåŠŸblock
 *  @param failureBlock                 å¤±è´¥block
 *
 *  @return è¯·æ±‚task
 */
- (NSURLSessionDataTask *)getRequest:(NSString *)url
                          parameters:(NSDictionary *)parameter
                     timeoutInterval:(NSTimeInterval)timeoutInterval
                        successBlock:(HYNetRequestSuccessBlock)successBlock
                        failureBlock:(HYNetRequestFailureBlock)failureBlock
    {
        __weak HYProjectNetRequestManager *weakSelf                 = self;
        AFHTTPSessionManager *sessionManager                        = self.sessionManager;
        sessionManager.requestSerializer.timeoutInterval            = timeoutInterval;
        
        /**
         *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
         */
        //NSDictionary *parameters                                    = [JZGEncyptClass parameterSortWithDictionary:parameter];
        NSURLSessionDataTask * dataTask                             = [sessionManager GET:url
                                                                               parameters:parameter
                                                                                 progress:^(NSProgress * _Nonnull downloadProgress) {}
                                                                                  success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                                                                                      
                                                                                      /**
                                                                                       *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                                                       */
                                                                                      [weakSelf.requests removeObject:task];
                                                                                      
                                                                                      /**
                                                                                       *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                                                       */
                                                                                      HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                                                      [self.requestInfo removeObject:infoModel];
                                                                                      
                                                                                      /**
                                                                                       *  æˆåŠŸå›è°ƒ
                                                                                       */
                                                                                      if (successBlock) {
                                                                                          infoModel.responseObject = task.response;
                                                                                          successBlock(responseObject, infoModel);
                                                                                      }
                                                                                  } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                                                      
                                                                                      /**
                                                                                       *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                                                       */
                                                                                      [weakSelf.requests removeObject:task];
                                                                                      
                                                                                      /**
                                                                                       *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                                                       */
                                                                                      HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                                                      [self.requestInfo removeObject:infoModel];
                                                                                      
                                                                                      /**
                                                                                       *  å¤±è´¥å›è°ƒ
                                                                                       */
                                                                                      if (failureBlock) {
                                                                                          failureBlock(error, infoModel);
                                                                                      }
                                                                                  }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    if(dataTask) {[self.requests addObject:dataTask];}
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:parameter];
    return dataTask;
}

/**
 *  postç½‘ç»œè¯·æ±‚
 *
 *  @param url                          urlé“¾æ¥
 *  @param parameter                    è¯·æ±‚å‚æ•°
 *  @param timeoutInterval              è¶…æ—¶æ—¶é—´
 *  @param successBlock                 æˆåŠŸblock
 *  @param failureBlock                 å¤±è´¥block
 *
 *  @return è¯·æ±‚task
 */
- (NSURLSessionDataTask *)postRequest:(NSString *)url
                       parameters:(NSDictionary *)parameter
                  timeoutInterval:(NSTimeInterval)timeoutInterval
                     successBlock:(HYNetRequestSuccessBlock)successBlock
                     failureBlock:(HYNetRequestFailureBlock)failureBlock
{
    __weak HYProjectNetRequestManager *weakSelf                 = self;
    AFHTTPSessionManager *sessionManager                        = self.sessionManager;
    sessionManager.requestSerializer.timeoutInterval            = timeoutInterval;
    NSMutableDictionary *para = [[NSMutableDictionary alloc] initWithDictionary:parameter];
    [para setValue:[USERDEFAULTS_GET(USER_TOKEN_KEY) isNullToString]forKey:@"token"];
    [para setValue:BASE_GCID forKey:@"gcid"];
    
    /**
     *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
     */
    
    NSURLSessionDataTask *dataTask = [sessionManager POST:url
                                               parameters:para
                                                 progress:^(NSProgress *uploadProgress) {}
                                                  success:^(NSURLSessionDataTask * _Nonnull task, id _Nullable responseObject) {
                                                      
                                                      /**
                                                       *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                       */
                                                      [weakSelf.requests removeObject:task];
                                                      
                                                      /**
                                                       *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                       */
                                                      HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                      [self.requestInfo removeObject:infoModel];
                                                      
                                                      /**
                                                       *  æˆåŠŸå›è°ƒ
                                                       */
                                                      if (successBlock) {
                                                          infoModel.responseObject = task.response;
                                                          successBlock(responseObject, infoModel);
                                                      }
                                                  } failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                      
                                                      LWLog(@"error.code==%@,description==%@",@(error.code),error.localizedDescription);
                                                      
                                                      /**
                                                       *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                       */
                                                      [weakSelf.requests removeObject:task];
                                                      
                                                      /**
                                                       *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                       */
                                                      HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                      [self.requestInfo removeObject:infoModel];
                                                      
                                                      /**
                                                       *  å¤±è´¥å›è°ƒ
                                                       */
                                                      if (failureBlock) {
                                                          failureBlock(error, infoModel);
                                                      }
                                                  }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    if(dataTask) {[self.requests addObject:dataTask];}
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:para];
    return dataTask;
    
}
    
/**
 *  ä¸Šä¼ å›¾ç‰‡ç½‘ç»œè¯·æ±‚ï¼ˆæµçš„æ–¹å¼ä¸Šä¼ ï¼‰
 *
 *  @param url                          urlé“¾æ¥
 *  @param parameter                    è¯·æ±‚å‚æ•°
 *  @param images                       éœ€è¦ä¸Šä¼ çš„å›¾ç‰‡æ•°ç»„
 *  @param fileName                     name å¿…ä¼ 
 *  @param timeInterval                 è¶…æ—¶æ—¶é—´ï¼ˆå•å¼ å›¾ç‰‡ä¸Šä¼ è¶…æ—¶æ—¶é—´ï¼‰
 *  @param successBlock                 æˆåŠŸblock
 *  @param failureBlock                 å¤±è´¥block
 *
 *  @return è¯·æ±‚task
 */
- (NSURLSessionDataTask *)uploadImageWithUrl:(NSString *)url
                               parameter:(NSDictionary *)parameter
                                  images:(NSArray *)images
                                fileName:(NSArray *)fileName
                         timeoutInterval:(NSTimeInterval)timeInterval
                            successBlock:(HYNetRequestSuccessBlock)successBlock
                            failureBlock:(HYNetRequestFailureBlock)failureBlock
{
    /**
     *  é…ç½®è¯·æ±‚å¤´ä¿¡æ¯
     */
    [HYNetRequestEncyptFatory setRequestHeaderWithSessionManager:self.sessionManager];
    
    AFHTTPSessionManager *sessionManager                    = self.sessionManager;
    NSTimeInterval timeIntervals                            = 0;
    if ([images count] >= 3) {
        timeIntervals = ([images count] / 3  + 1) * timeInterval;
    }else{
        timeIntervals = timeInterval;
    }
    sessionManager.requestSerializer.timeoutInterval        = timeIntervals;
    
    /**
     å›¾ç‰‡æ•°ç»„ è½¬æˆdataæ•°ç»„ ï¼ˆå¤§äº5M å°±é™ä½è´¨é‡ï¼‰
     */
    NSMutableArray *imageDataArr = [NSMutableArray arrayWithCapacity:1];
    for ( int i = 0; i < images.count; i++) {
        NSData *imageData = UIImagePNGRepresentation(images[i]);
        if (imageData.length/1024/1024>5) {
            imageData = UIImageJPEGRepresentation(images[i], 0.5);
        }
        [imageDataArr addObject:imageData];
    }
    NSMutableArray *temp = [NSMutableArray arrayWithCapacity:images.count];
    
    if (fileName.count < images.count) {
        for (int i = 0 ; i < images.count; i ++) {
            if (i + 1 > fileName.count) {
                [temp addObject:@"pic"];
            }
        }
        fileName = temp;
    }
    
    /**
     *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
     */
    NSDictionary *parameters = parameter;
    NSURLSessionDataTask * dataTask = [sessionManager POST:url
                                                parameters:parameters
                                 constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
                                   
                                     for (NSInteger i = 0; i < [images count]; i++) {
                                         [formData appendPartWithFileData:[imageDataArr objectAtIndex:i]
                                                                     name:fileName[i]
                                                                 fileName:[NSString stringWithFormat:@"%@.png",fileName[i]]
                                                                 mimeType:@"image/png/jpg/gif/jpeg/bmp"];
                                     }
                                 }
                                                  progress:^(NSProgress * _Nonnull uploadProgress) {
//                                                      CGFloat calculationProgress = (CGFloat)uploadProgress.completedUnitCount / (CGFloat)uploadProgress.totalUnitCount;
//                                                      [SVProgressHUD showProgress:calculationProgress status:@"ç…§ç‰‡ä¸Šä¼ ä¸­..."];
//                                                      [SVProgressHUD setDefaultMaskType:SVProgressHUDMaskTypeClear];
                                                      
                                                  }
                                                   success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                                                       [SVProgressHUD dismiss];
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  æˆåŠŸå›è°ƒ
                                                        */
                                                       if (successBlock) {
                                                           infoModel.responseObject = task.response;
                                                           successBlock(responseObject, infoModel);
                                                       }
                                                   }
                                                   failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                       [SVProgressHUD dismiss];
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  å¤±è´¥å›è°ƒ
                                                        */
                                                       if (failureBlock) {
                                                           failureBlock(error, infoModel);
                                                       }
                                                   }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    if(dataTask) {[self.requests addObject:dataTask];}
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:parameters];
    return dataTask;
}

/**
 ä¸Šä¼ å•å¼ å›¾ç‰‡
 */
- (NSURLSessionDataTask *)uploadSingleImageWithUrl:(NSString *)url
                 parameter:(NSDictionary *)parameter
                    image:(UIImage *)image
                  fileName:(NSString *)fileName
           timeoutInterval:(NSTimeInterval)timeInterval
              successBlock:(HYNetRequestSuccessBlock)successBlock
              failureBlock:(HYNetRequestFailureBlock)failureBlock
{
    /**
     *  é…ç½®è¯·æ±‚å¤´ä¿¡æ¯
     */
    [HYNetRequestEncyptFatory setRequestHeaderWithSessionManager:self.sessionManager];
    
    AFHTTPSessionManager *sessionManager                    = self.sessionManager;
    sessionManager.requestSerializer.timeoutInterval        = timeInterval;
    
    /**
     å›¾ç‰‡æ•°ç»„ è½¬æˆdataæ•°ç»„ ï¼ˆå¤§äº5M å°±é™ä½è´¨é‡ï¼‰
     */
    
    NSData *imageData = UIImagePNGRepresentation(image);
    
        if (imageData.length/1024/1024>5) {
            imageData = UIImageJPEGRepresentation(image, 0.5);
        }
    
    if (!fileName) {
        fileName = @"pic";
    }
    /**
     *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
     */
    NSDictionary *parameters = parameter;
    NSURLSessionDataTask * dataTask = [sessionManager POST:url
                                                parameters:parameters
                                 constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
                                     
                                     [formData appendPartWithFileData:imageData
                                                                 name:fileName
                                                             fileName:[NSString stringWithFormat:@"%@.png",fileName]
                                                             mimeType:@"image/png/jpg/gif/jpeg/bmp"];
                                     
                                 }
                                                  progress:^(NSProgress * _Nonnull uploadProgress) {
                                                      
                                                  }
                                                   success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  æˆåŠŸå›è°ƒ
                                                        */
                                                       if (successBlock) {
                                                           infoModel.responseObject = task.response;
                                                           successBlock(responseObject, infoModel);
                                                       }
                                                   }
                                                   failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                       [SVProgressHUD dismiss];
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  å¤±è´¥å›è°ƒ
                                                        */
                                                       if (failureBlock) {
                                                           failureBlock(error, infoModel);
                                                       }
                                                   }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    if(dataTask) {[self.requests addObject:dataTask];}
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:parameters];
    return dataTask;
}

/**
 *  æ‰“åŒ…ä¸Šä¼ æ–‡ä»¶ç½‘ç»œè¯·æ±‚ï¼ˆæ–‡ä»¶çš„æ–¹å¼ä¸Šä¼ ï¼‰
 *
 *  @param url                          urlé“¾æ¥
 *  @param parameter                    è¯·æ±‚å‚æ•°
 *  @param imagesZipPath                éœ€è¦ä¸Šä¼ çš„æœ¬åœ°zipæ–‡ä»¶åœ°å€
 *  @param successBlock                 æˆåŠŸblock
 *  @param failureBlock                 å¤±è´¥block
 *
 *  @return è¯·æ±‚task
 */
- (NSURLSessionDataTask *)uploadImageZipWithUrl:(NSString *)url
                                 parameters:(NSDictionary *)parameter
                              imagesZipPath:(NSURL *)imagesZipPath
                               successBlock:(HYNetRequestSuccessBlock)successBlock
                               failureBlock:(HYNetRequestFailureBlock)failureBlock
{
    AFHTTPSessionManager *sessionManager                        = self.sessionManager;
    sessionManager.requestSerializer.timeoutInterval            = 120;
    
    /**
     *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
     */
    NSDictionary *parameters                                    = parameter;
    
    NSURLSessionDataTask * dataTask = [sessionManager POST:url
                                                parameters:parameters
                                 constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
                                     [formData appendPartWithFileURL:imagesZipPath
                                                                name:@"file"
                                                            fileName:@"file.zip"
                                                            mimeType:@"application/zip"
                                                               error:nil];
                                 }
                                                  progress:^(NSProgress * _Nonnull uploadProgress) {
                                                      
                                                  }
                                                   success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                                                       
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  æˆåŠŸå›è°ƒ
                                                        */
                                                       if (successBlock) {
                                                           infoModel.responseObject = task.response;
                                                           successBlock(responseObject, infoModel);
                                                       }
                                                   }
                                                   failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                       
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  å¤±è´¥å›è°ƒ
                                                        */
                                                       if (failureBlock) {
                                                           failureBlock(error, infoModel);
                                                       }
                                                   }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    [self.requests addObject:dataTask];
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:parameters];
    return dataTask;
}

/**
 *  ä¸Šä¼ è§†é¢‘ç½‘ç»œè¯·æ±‚
 *
 *  @param url                          urlé“¾æ¥
 *  @param parameter                    è¯·æ±‚å‚æ•°
 *  @param videoPath                    è§†é¢‘é€”å¾„
 *  @param successBlock                 æˆåŠŸblock
 *  @param failureBlock                 å¤±è´¥block
 *
 *  @return è¯·æ±‚task
 */
- (NSURLSessionDataTask *)uploadVideoWithUrl:(NSString *)url
                              parameters:(NSDictionary *)parameter
                         timeoutInterval:(NSTimeInterval)timeoutInterval
                               videoPath:(NSURL *)videoPath
                            successBlock:(HYNetRequestSuccessBlock)successBlock
                            failureBlock:(HYNetRequestFailureBlock)failureBlock
{
    AFHTTPSessionManager *sessionManager                                = self.sessionManager;
    sessionManager.requestSerializer.timeoutInterval                    = timeoutInterval;
    
    /**
     *  TODO:åŠ å¯†æˆ–ç‰¹æ®Šå¤„ç†å‚æ•°
     */
    NSDictionary *parameters                                            = parameter;
    NSURLSessionDataTask * dataTask = [sessionManager POST:url
                                                parameters:parameters
                                 constructingBodyWithBlock:^(id<AFMultipartFormData>  _Nonnull formData) {
                                     [formData appendPartWithFileURL:videoPath
                                                                name:@""
                                                            fileName:@""
                                                            mimeType:@"mpeg4/mov"
                                                               error:nil];
                                 }
                                                  progress:^(NSProgress * _Nonnull uploadProgress) {
                                                      
                                                  }
                                                   success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {
                                                       
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  æˆåŠŸå›è°ƒ
                                                        */
                                                       if (successBlock) {
                                                           infoModel.responseObject = task.response;
                                                           successBlock(responseObject, infoModel);
                                                       }
                                                   }
                                                   failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {
                                                       
                                                       /**
                                                        *  å°†è¯·æ±‚ä»è¯·æ±‚æ•°ç»„ä¸­ç§»é™¤
                                                        */
                                                       [self.requests removeObject:task];
                                                       
                                                       /**
                                                        *  å…ˆè·å–å¯¹åº”çš„modelå¯¹è±¡ï¼Œå†ä»æ•°ç»„ä¸­ç§»é™¤å¯¹åº”çš„model
                                                        */
                                                       HYProjectNetRequestInfo *infoModel = [self getInfoModelWithTask:task];
                                                       [self.requestInfo removeObject:infoModel];
                                                       
                                                       /**
                                                        *  å¤±è´¥å›è°ƒ
                                                        */
                                                       if (failureBlock) {
                                                           failureBlock(error, infoModel);
                                                       }
                                                   }];
    
    /**
     *  å°†è¯·æ±‚åŠ å…¥è¯·æ±‚æ•°ç»„ä¸­
     */
    [self.requests addObject:dataTask];
    
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    [self addToArrayWithNewTask:dataTask url:url info:parameters];
    return dataTask;
}

/**
 *  å°†è¯·æ±‚ç›¸å…³æ•°æ®æ·»åŠ åˆ°æ•°ç»„ä¸­
 *
 *  @param dataTask         dataTask
 *  @param url              url
 *  @param info             info
 */
-(void)addToArrayWithNewTask:(NSURLSessionTask *)dataTask
                         url:(NSString *)url
                        info:(NSDictionary *)info
{
    /**
     *  ç”±äºios7ç³»ç»Ÿç»™NSURLSessionTaskæ·»åŠ ç±»ç›®å±æ€§ä¼šå´©æºƒï¼Œæ‰€ä»¥æ”¹ç”¨æ­¤æ–¹æ³•
     */
    HYProjectNetRequestInfo *requestInfoModel                   = [[HYProjectNetRequestInfo alloc]init];
    requestInfoModel.sessionTask                                = dataTask;
    requestInfoModel.urlString                                  = url;
    requestInfoModel.requestParam                               = info;
    requestInfoModel.timeStamp                                  = [NSDate ex_getCurrentTimeStamp];
    [self.requestInfo addObject:requestInfoModel];
}

/**
 *  æ ¹æ®taskï¼Œä»requestInfoæ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„model
 *
 *  @param dataTask dataTask
 *  @return model
 */
- (HYProjectNetRequestInfo *)getInfoModelWithTask:(NSURLSessionTask *)dataTask
{
    __block HYProjectNetRequestInfo *infoModel;
    [self.requestInfo enumerateObjectsUsingBlock:^(HYProjectNetRequestInfo *  _Nonnull obj,
                                                   NSUInteger idx,
                                                   BOOL * _Nonnull stop) {
        if ([dataTask isEqual:obj.sessionTask]) {
            infoModel               = obj;
            *stop                   = YES;
        }
    }];
    
    return infoModel;
}

/**
 *  å–æ¶ˆæ‰€æœ‰ç½‘ç»œè¯·æ±‚
 */
- (void)cancelNetworkRequest
{
    /**
     *  å¯ä»¥ä½¿ç”¨è¯¥ç§æ–¹æ³•ç›´æ¥å–æ¶ˆæ‰€æœ‰ç½‘ç»œè¯·æ±‚æˆ–è€…éå†requestsé›†åˆï¼Œé€ä¸ªè°ƒç”¨cancelæ–¹æ³•
     */
    [self.sessionManager.operationQueue cancelAllOperations];
}

/**
 *  å–æ¶ˆå•ä¸ªç½‘ç»œè¯·æ±‚
 *
 *  @param task éœ€è¦è¢«å–æ¶ˆçš„è¯·æ±‚task
 */
- (void)cancelNetworkRequestWithTask:(NSURLSessionTask *)task
{
    /**
     *  å¦‚æœè¦å–æ¶ˆçš„è¯·æ±‚æ­£åœ¨è¿è¡Œä¸­ï¼Œè¿›è¡Œå–æ¶ˆæ“ä½œ
     */
    if (task.state == NSURLSessionTaskStateRunning) {
        
        /**
         *  cancel ä¹‹åä¼šèµ°å¤±è´¥blockï¼Œè€Œå¤±è´¥blocké‡Œå·²ç»å°†è¯¥taskç§»é™¤äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦ç§»é™¤
         */
        [task cancel];
        return;
    }else{
        
        LWLog(@"%@", @"ç½‘ç»œè¯·æ±‚å¹¶æœªè¿è¡Œï¼Œæ— éœ€å–æ¶ˆ");
    }
}

/**
 *  å–æ¶ˆå•ä¸ªç½‘ç»œè¯·æ±‚é€šè¿‡urlString ä¸ğŸ‘†ğŸ‘†ğŸ‘†æ–¹æ³•äºŒé€‰ä¸€å³å¯
 *
 *  @param urlString                    éœ€è¦è¢«å–æ¶ˆçš„è¯·æ±‚urlString
 *  @param type                         POST/GET
 */
- (void)cancelNetworkRequestWithUrlString:(NSString *)urlString
                                 type:(NSString *)type
{
    NSError * error;
    /**
     *  æ ¹æ®è¯·æ±‚çš„ç±»å‹ ä»¥åŠ è¯·æ±‚çš„urlåˆ›å»ºä¸€ä¸ªNSMutableURLRequest
     *  é€šè¿‡è¯¥urlå»åŒ¹é…è¯·æ±‚é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰è¯¥url,å¦‚æœæœ‰çš„è¯ é‚£ä¹ˆå°±å–æ¶ˆè¯¥è¯·æ±‚
     */
    NSString * urlToPeCanced                                    = [[[self.sessionManager.requestSerializer requestWithMethod:type
                                                                                                                   URLString:urlString
                                                                                                                  parameters:nil
                                                                                                                       error:&error] URL] path];
    for (NSOperation * operation in self.sessionManager.operationQueue.operations) {
        if ([operation isKindOfClass:[NSURLSessionTask class]]) {
            BOOL hasMatchRequestType                            = [type isEqualToString:[[(NSURLSessionTask *)operation currentRequest] HTTPMethod]];
            BOOL hasMatchRequestUrlString                       = [urlToPeCanced isEqualToString:[[[(NSURLSessionTask *)operation currentRequest] URL] path]];
            if (hasMatchRequestType&&hasMatchRequestUrlString) {
                [operation cancel];
            }
        }
        [operation cancel];
    }
}

/**
 *  è·å–å½“å‰ç½‘ç»œçš„çŠ¶æ€ï¼Œä¸»è¦æ˜¯çœ‹æ˜¯å¦æœ‰ç½‘ç»œã€‚
 *
 *  @return è¿”å›å€¼ YES è¯´æ˜å½“å‰ç½‘ç»œå¯ç”¨ï¼Œ NO è¯´æ˜å½“å‰ç½‘ç»œä¸å¯ç”¨
 */
- (BOOL)netWorkingStatus
{
    BOOL    status;
    switch (self.currentNetStatus) {
        
        /**
         *  æœªçŸ¥ç½‘ç»œ
         */
        case AFNetworkReachabilityStatusUnknown:
        status = NO;
        break;
        
        /**
         *  æ²¡æœ‰ç½‘ç»œ(æ–­ç½‘)
         */
        case AFNetworkReachabilityStatusNotReachable:
        status = NO;
        break;
        
        /**
         *  æ‰‹æœºè‡ªå¸¦ç½‘ç»œ
         */
        case AFNetworkReachabilityStatusReachableViaWWAN:
        status = YES;
        break;
        
        /**
         *  WIFI
         */
        case AFNetworkReachabilityStatusReachableViaWiFi:
        status = YES;
        break;
    }
    return status;
}

#pragma mark - Third.Lazy

- (AFHTTPSessionManager *)sessionManager
{
    if (!_sessionManager) {
        AFHTTPSessionManager *sessionManager                        = [[AFHTTPSessionManager alloc] initWithBaseURL:[NSURL URLWithString:BASE_URL]];
        AFJSONResponseSerializer *serializer                        = [AFJSONResponseSerializer serializer];
        serializer.removesKeysWithNullValues                        = YES;
        serializer.acceptableContentTypes                           = [NSSet setWithObjects:
                                                                       @"application/json",
                                                                       @"text/javascript",
                                                                       @"text/json",
                                                                       @"text/plain",
                                                                       @"text/html",
                                                                       @"application/zip",
                                                                       nil];
        sessionManager.responseSerializer                           = serializer;
        _sessionManager                                             = sessionManager;
    }
    return _sessionManager;
}

- (NSMutableArray *)requests
{
    if (!_requests) {
        _requests                                                   = [NSMutableArray array];
    }
    return _requests;
}

- (NSMutableArray *)requestInfo
{
    if (!_requestInfo) {
        _requestInfo                                                = [NSMutableArray array];
    }
    return _requestInfo;
}

@end
